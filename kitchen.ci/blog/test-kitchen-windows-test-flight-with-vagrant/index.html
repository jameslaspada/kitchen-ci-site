<html lang=en> <!--[if lt IE 7]>html.no-js.lt-ie9.lt-ie8.lt-ie7 lang="en"<![endif]--> <!--[if IE 7]>html.no-js.lt-ie9.lt-ie8 lang="en"<![endif]--> <!--[if IE 8]>html.no-js.lt-ie9 lang="en"<![endif]--> <!--[if (gte IE 8)]><html class=no-js><![endif]--> 
<!-- Mirrored from kitchen.ci/blog/test-kitchen-windows-test-flight-with-vagrant/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 17 Aug 2015 23:12:36 GMT -->
<head> <meta charset=utf-8> <meta content='IE=edge' http-equiv=X-UA-Compatible> <title> Test Kitchen Windows Test Flight with Vagrant - KitchenCI </title> <meta content='Test Kitchen' name=description> <meta content='Fletcher Nichol' name=author> <meta content='width=device-width, initial-scale=1.0' name=viewport> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="../feed.xml"/> <link href="../../css/kitchen-26ac5aa6.css" media=screen rel=stylesheet /> <link href="http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700" media=screen rel=stylesheet /> <link href="http://fonts.googleapis.com/css?family=Open+Sans" media=screen rel=stylesheet /> <link href="http://fonts.googleapis.com/css?family=Inconsolata" media=screen rel=stylesheet /> </head> <body> <!--[if lt IE 7]><p class=browsehappy>You are using an <strong>outdated</strong> browser. Please <a href='//browsehappy.com/'>upgrade your browser</a> to improve your experience.</p><![endif]--> <nav class='navbar navbar-inverse navbar-fixed-top' role=navigation> <div class=container> <div class=navbar-header> <div class='button navbar-toggle' data-target='.navbar-collapse' data-toggle=collapse type=button> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </div> <a class=navbar-brand href="../../index.html">KitchenCI</a> </div> <div class='navbar-collapse collapse'> <ul class='nav navbar-nav'> <li class=''> <a href="../../index.html">Home</a> </li> <li class=''> <a href="../index.html">Blog</a> </li> <li class=''> <a href="../../docs/getting-started/index.html">Guide</a> </li> </ul> <ul class='nav navbar-nav navbar-right' id=contacts> <li> <a href='http://twitter.com/kitchenci'> <i class='fa fa-twitter'></i> </a> </li> <li> <a href='http://github.com/test-kitchen'> <i class='fa fa-github'></i> </a> </li> </ul> </div> </div> </nav> <div class=welcomewrap> <h1>Test Kitchen Blog</h1> </div> <div class='container blog'> <div class=row> <article class='col-md-12 col-sm-12'> <h2>Test Kitchen Windows Test Flight with Vagrant</h2> <p class=posted> by Fletcher Nichol on <time datatime=2015-04-28>Tuesday, April 28 2015</time> </p> <section> <p>As mentioned in the <a href="../test-kitchen-1-4-0-release-notes.html">1.4.0 release notes</a>, you can now spin up instances running various versions of Windows. If would you like to try out this new functionality using nothing more than your workstation, read on.</p>&#x000A;&#x000A;<p></p>&#x000A;&#x000A;<p>There are a few things we'll cover in this post:</p>&#x000A;&#x000A;<ol>&#x000A; <li>Installing the vagrant-winrm Vagrant plugin</li>&#x000A; <li>Building a Windows Vagrant box</li>&#x000A; <li>Create a sample cookbook using the ChefDK</li>&#x000A;</ol>&#x000A;&#x000A;<p>We'll assume that the latest Test Kitchen and Kitchen::Vagrant Driver are installed (see the <a href="../test-kitchen-1-4-0-release-notes.html">1.4.0 release notes</a> for more details).</p>&#x000A;&#x000A;<h2 id=windows-with-kitchenvagrant>Windows with Kitchen::Vagrant</h2>&#x000A;&#x000A;<p>The <a href="https://github.com/test-kitchen/kitchen-vagrant/releases/tag/v0.17.0">kitchen-vagrant 0.17.0</a> release comes with awareness and support for spinning up Windows instances, so be sure to use this version or higher if Vagrant is your Driver of choice.</p>&#x000A;&#x000A;<p>To make the WinRM host and port detection logic work, you will need to install one Vagrant plugin called <code>vagrant-winrm</code>. To install this, please run the following:</p>&#x000A;&#x000A;<pre class="highlight shell">vagrant plugin install vagrant-winrm&#x000A;</pre>&#x000A;<table>&#x000A; <tbody>&#x000A; <tr>&#x000A; <td> </td>&#x000A; <td>Note</td>&#x000A; </tr>&#x000A; <tr>&#x000A; <td> </td>&#x000A; <td>You do <strong>not</strong> want to prepend <code>bundle exec</code> or anything else; this is a Vagrant plugin and will be available to any future Vagrant projects on your workstation.</td>&#x000A; </tr>&#x000A; </tbody>&#x000A;</table>&#x000A;&#x000A;<p>If you forget this step then don't worry, any <code>kitchen</code> command that needs it will prompt you like so:</p>&#x000A;&#x000A;<pre class="highlight plaintext">kitchen list&#x000A;&gt;&gt;&gt;&gt;&gt;&gt; ------Exception-------&#x000A;&gt;&gt;&gt;&gt;&gt;&gt; Class: Kitchen::UserError&#x000A;&gt;&gt;&gt;&gt;&gt;&gt; Message: WinRM Transport requires the vagrant-winrm Vagrant plugin to properly communicate with this Vagrant VM. Please install this plugin with: `vagrant plugin install vagrant-winrm' and try again.&#x000A;&gt;&gt;&gt;&gt;&gt;&gt; ----------------------&#x000A;&gt;&gt;&gt;&gt;&gt;&gt; Please see .kitchen/logs/kitchen.log for more details&#x000A;&gt;&gt;&gt;&gt;&gt;&gt; Also try running `kitchen diagnose --all` for configuration&#x000A;</pre>&#x000A;<p>Run <code>vagrant plugin install vagrant-winrm</code> and try again.</p>&#x000A;&#x000A;<p>Now, assuming you have a Vagrant base box called "windows-2012r2", you can use a .kitchen.yml similar to:</p>&#x000A;&#x000A;<pre class="highlight yaml"><span class="nn">---</span>&#x000A;<span class="s">driver</span><span class="pi">:</span>&#x000A;  <span class="s">name</span><span class="pi">:</span> <span class="s">vagrant</span>&#x000A;&#x000A;<span class="s">platforms</span><span class="pi">:</span>&#x000A;  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">windows-2012r2</span>&#x000A;&#x000A;<span class="s">suites</span><span class="pi">:</span>&#x000A;  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">default</span>&#x000A;</pre>&#x000A;<p>Note that with the updates in kitchen-vagrant you don’t need to set/override a <code>:box</code>, <code>:box_url</code>, <code>:communicator</code>, <code>:guest</code>, <code>:port</code>, <code>:username</code>, or <code>:password</code>. Sane defaults should apply.</p>&#x000A;&#x000A;<p>For anyone who has tried the now defunct windows-guest-support branch, you may have seen extra transport configuration like this:</p>&#x000A;&#x000A;<pre class="highlight yaml"><span class="nn">---</span>&#x000A;<span class="s">driver</span><span class="pi">:</span>&#x000A;  <span class="s">name</span><span class="pi">:</span> <span class="s">vagrant</span>&#x000A;&#x000A;<span class="s">platforms</span><span class="pi">:</span>&#x000A;  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">windows-2012r2</span>&#x000A;    <span class="s">transport</span><span class="pi">:</span>&#x000A;      <span class="s">name</span><span class="pi">:</span> <span class="s">winrm</span>&#x000A;&#x000A;<span class="s">suites</span><span class="pi">:</span>&#x000A;  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">default</span>&#x000A;</pre>&#x000A;<p>This is what Test Kitchen’s going to give you by default for any platform name starting with /^win/ (case insensitive) so add it, or don’t, it should work either way. If you don’t believe me, run <code>kitchen diagnose</code> against both and note the difference :)</p>&#x000A;&#x000A;<p>Any Vagrant base box should have <code>vm.communicator = “winrm”</code> and <code>vm.guest = “windows”</code> set by default, otherwise <code>vagrant up</code> will not be able to correctly boot the VM. Note that there are some Windows base boxes out there with <code>vm.communicator = “ssh”</code> set, so plan accordingly.</p>&#x000A;&#x000A;<h2 id=building-windows-vagrant-boxes>Building Windows Vagrant Boxes</h2>&#x000A;&#x000A;<p>Due to Microsoft's EULA restrictions, it isn't currently possible to distribute Windows Vagrant boxes–even if they are evaluation versions from publicly downloadable ISO images. This leaves us with the task of building the boxes ourselves, but thankfully <a href="https://packer.io/">Packer</a> makes this a good deal easier.</p>&#x000A;&#x000A;<p>To test the functionality of Test Kitchen in development, the <a href="https://github.com/boxcutter/windows">boxcutter/windows</a> was used to create various Windows box versions. You will need <a href="https://packer.io/downloads.html">Packer</a> installed but should work on most operating systems. For example, here's how you can build your own Windows Server 2012r2 evaluation box using Boxcutter:</p>&#x000A;&#x000A;<pre class="highlight shell">git clone https://github.com/boxcutter/windows.git&#x000A;<span class="nb">cd </span>windows&#x000A;make virtualbox/eval-win2012r2-standard&#x000A;</pre>&#x000A;<p>Note that on my 13" MacBook Retina the download-to-built time was 44 minutes. Long, but not bad considering. Also, if VMware is your cup of tea, try <code>make vmware/eval-win2012r2-standard</code>.</p>&#x000A;&#x000A;<p>Finally, add the build box to Vagrant, calling it <code>"windows-2012r2"</code> (a box starting with "win" will help Test Kitchen do the right thing out of the box):</p>&#x000A;&#x000A;<pre class="highlight shell">vagrant box add windows-2012r2 ./box/virtualbox/eval-win2012r2-standard-nocm-1.0.4.box&#x000A;</pre>&#x000A;<p>Also note that the <a href="https://github.com/joefitzgerald/packer-windows">joefitzgerald/packer-windows</a> also creates a wide variety of Windows Vagrant boxes and may be more your speed if looking for alternatives.</p>&#x000A;&#x000A;<h2 id=test-flight>Test Flight</h2>&#x000A;&#x000A;<p>Now that we have a Windows box, let's try it out! This example uses <a href="https://downloads.chef.io/chef-dk/">ChefDK</a> to generate a cookbook:</p>&#x000A;&#x000A;<pre class="highlight shell">chef generate cookbook hello&#x000A;<span class="nb">cd </span>hello&#x000A;</pre>&#x000A;<p>Next, we'll edit the <code>.kitchen.yml</code> file to use a single platform–Windows 2012r2:</p>&#x000A;&#x000A;<pre class="highlight yaml"><span class="nn">---</span>&#x000A;<span class="s">driver</span><span class="pi">:</span>&#x000A;  <span class="s">name</span><span class="pi">:</span> <span class="s">vagrant</span>&#x000A;&#x000A;<span class="s">provisioner</span><span class="pi">:</span>&#x000A;  <span class="s">name</span><span class="pi">:</span> <span class="s">chef_zero</span>&#x000A;&#x000A;<span class="s">platforms</span><span class="pi">:</span>&#x000A;  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">windows-2012r2</span>&#x000A;&#x000A;<span class="s">suites</span><span class="pi">:</span>&#x000A;  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">default</span>&#x000A;    <span class="s">run_list</span><span class="pi">:</span>&#x000A;      <span class="pi">-</span> <span class="s">recipe[hello::default]</span>&#x000A;</pre>&#x000A;<p>Finally, let's add a simple <a href="http://docs.chef.io/resource_log.html">log resource</a> into our default recipe:</p>&#x000A;&#x000A;<pre class="highlight shell"><span class="nb">echo</span> <span class="s1">'log "Hello, Windows"'</span> &gt;&gt; recipes/default.rb&#x000A;</pre>&#x000A;<p>You should now be able to run <code>kitchen list</code>:</p>&#x000A;&#x000A;<pre class="highlight shell">kitchen list&#x000A;</pre>&#x000A;<p>and see our single instance, using the WinRM transport:</p>&#x000A;&#x000A;<pre class="highlight plaintext">Instance                Driver   Provisioner  Verifier  Transport  Last Action&#x000A;default-windows-2012r2  Vagrant  ChefZero     Busser    Winrm      &lt;Not Created&gt;&#x000A;</pre>&#x000A;<p>Why not give this a spin while we're at it?</p>&#x000A;&#x000A;<pre class="highlight shell">kitchen <span class="nb">test</span>&#x000A;</pre>&#x000A;<p>You'll see something like the following:</p>&#x000A;&#x000A;<pre class="highlight plaintext">-----&gt; Starting Kitchen (v1.4.0)&#x000A;-----&gt; Cleaning up any prior instances of &lt;default-windows-2012r2&gt;&#x000A;-----&gt; Destroying &lt;default-windows-2012r2&gt;...&#x000A;       Finished destroying &lt;default-windows-2012r2&gt; (0m0.00s).&#x000A;-----&gt; Testing &lt;default-windows-2012r2&gt;&#x000A;-----&gt; Creating &lt;default-windows-2012r2&gt;...&#x000A;       Bringing machine 'default' up with 'vmware_fusion' provider...&#x000A;       ==&gt; default: Cloning VMware VM: 'windows-2012r2'. This can take some time...&#x000A;       ==&gt; default: Verifying vmnet devices are healthy...&#x000A;       ==&gt; default: Preparing network adapters...&#x000A;       ==&gt; default: Starting the VMware VM...&#x000A;       ==&gt; default: Waiting for machine to boot. This may take a few minutes...&#x000A;       ==&gt; default: Machine booted and ready!&#x000A;       ==&gt; default: Forwarding ports...&#x000A;           default: -- 3389 =&gt; 3389&#x000A;           default: -- 5985 =&gt; 5985&#x000A;           default: -- 22 =&gt; 2222&#x000A;       ==&gt; default: Configuring network adapters within the VM...&#x000A;       ==&gt; default: Configuring secondary network adapters through VMware&#x000A;       ==&gt; default: on Windows is not yet supported. You will need to manually&#x000A;       ==&gt; default: configure the network adapter.&#x000A;       ==&gt; default: Machine not provisioning because `--no-provision` is specified.&#x000A;       [WinRM] Established&#x000A;       Vagrant instance &lt;default-windows-2012r2&gt; created.&#x000A;       Finished creating &lt;default-windows-2012r2&gt; (1m3.04s).&#x000A;-----&gt; Converging &lt;default-windows-2012r2&gt;...&#x000A;       Preparing files for transfer&#x000A;       Preparing dna.json&#x000A;       Resolving cookbook dependencies with Berkshelf 3.2.3...&#x000A;       Removing non-cookbook files before transfer&#x000A;       Preparing validation.pem&#x000A;       Preparing client.rb&#x000A;-----&gt; Installing Chef Omnibus (install only if missing)&#x000A;       Downloading package from https://opscode-omnibus-packages.s3.amazonaws.com/windows/2008r2/x86_64/chef-client-12.2.1-1.msi&#x000A;       Download complete.&#x000A;       Successfully verified C:\Users\vagrant\AppData\Local\Temp\chef-true.msi&#x000A;&#x000A;       Installing Chef Omnibus package C:\Users\vagrant\AppData\Local\Temp\chef-true.msi&#x000A;       Installation complete&#x000A;       Transferring files to &lt;default-windows-2012r2&gt;&#x000A;       Starting Chef Client, version 12.2.1&#x000A;       Creating a new client identity for default-windows-2012r2 using the validator key.&#x000A;       [2015-04-27T13:58:06-07:00] WARN: Child with name 'dna.json' found in multiple directories: C:/Users/vagrant/AppData/Local/Temp/kitchen/dna.json and C:/Users/vagrant/AppData/Local/Temp/kitchen/dna.json&#x000A;       [2015-04-27T13:58:06-07:00] WARN: Child with name 'dna.json' found in multiple directories: C:/Users/vagrant/AppData/Local/Temp/kitchen/dna.json and C:/Users/vagrant/AppData/Local/Temp/kitchen/dna.json&#x000A;       resolving cookbooks for run list: ["hello::default"]&#x000A;       [2015-04-27T13:58:06-07:00] WARN: Child with name 'dna.json' found in multiple directories: C:/Users/vagrant/AppData/Local/Temp/kitchen/dna.json and C:/Users/vagrant/AppData/Local/Temp/kitchen/dna.json&#x000A;       Synchronizing Cookbooks:&#x000A;         - hello&#x000A;       Compiling Cookbooks...&#x000A;       Converging 1 resources&#x000A;       Recipe: hello::default&#x000A;         * log[Hello, Windows] action write&#x000A;&#x000A;&#x000A;       Running handlers:&#x000A;       Running handlers complete&#x000A;       Chef Client finished, 1/1 resources updated in 13.486613 seconds&#x000A;       Finished converging &lt;default-windows-2012r2&gt; (2m25.94s).&#x000A;-----&gt; Setting up &lt;default-windows-2012r2&gt;...&#x000A;       Finished setting up &lt;default-windows-2012r2&gt; (0m0.00s).&#x000A;-----&gt; Verifying &lt;default-windows-2012r2&gt;...&#x000A;       Preparing files for transfer&#x000A;-----&gt; Installing Busser (busser)&#x000A;       Successfully installed thor-0.19.0&#x000A;       Successfully installed busser-0.7.1&#x000A;       2 gems installed&#x000A;-----&gt; Setting up Busser&#x000A;       Creating BUSSER_ROOT in C:\Users\vagrant\AppData\Local\Temp\verifier&#x000A;       Creating busser binstub&#x000A;       Installing Busser plugins: busser-serverspec&#x000A;       Plugin serverspec installed (version 0.5.6)&#x000A;-----&gt; Running postinstall for serverspec plugin&#x000A;       Suite path directory C:/Users/vagrant/AppData/Local/Temp/verifier/suites does not exist, skipping.&#x000A;       Transferring files to &lt;default-windows-2012r2&gt;&#x000A;-----&gt; Running serverspec test suite&#x000A;-----&gt; Installing Serverspec..&#x000A;-----&gt; serverspec installed (version 2.14.1)&#x000A;&#x000A;       hello::default&#x000A;         does something (PENDING: Replace this with meaningful tests)&#x000A;&#x000A;       Pending: (Failures listed here are expected and do not affect your suite's status)&#x000A;&#x000A;         1) hello::default does something&#x000A;            # Replace this with meaningful tests&#x000A;            # ./AppData/Local/Temp/verifier/suites/serverspec/default_spec.rb:8&#x000A;&#x000A;       Finished in 0 seconds (files took 0.45317 seconds to load)&#x000A;       1 example, 0 failures, 1 pending&#x000A;&#x000A;       C:/opscode/chef/embedded/bin/ruby.exe -IC:/Users/vagrant/AppData/Local/Temp/verifier/suites/serverspec -I'C:/Users/vagrant/AppData/Local/Temp/verifier/gems/gems/rspec-support-3.2.2/lib';'C:/Users/vagrant/AppData/Local/Temp/verifier/gems/gems/rspec-core-3.2.3/lib' 'C:/Users/vagrant/AppData/Local/Temp/verifier/gems/gems/rspec-core-3.2.3/exe/rspec' --pattern 'C:/Users/vagrant/AppData/Local/Temp/verifier/suites/serverspec/**/*_spec.rb' --color --format documentation --default-path C:/Users/vagrant/AppData/Local/Temp/verifier/suites/serverspec&#x000A;       Finished verifying &lt;default-windows-2012r2&gt; (5m28.08s).&#x000A;-----&gt; Destroying &lt;default-windows-2012r2&gt;...&#x000A;       ==&gt; default: Stopping the VMware VM...&#x000A;       ==&gt; default: Deleting the VM...&#x000A;       Vagrant instance &lt;default-windows-2012r2&gt; destroyed.&#x000A;       Finished destroying &lt;default-windows-2012r2&gt; (0m10.99s).&#x000A;       Finished testing &lt;default-windows-2012r2&gt; (9m8.07s).&#x000A;-----&gt; Kitchen is finished. (9m10.23s)&#x000A;</pre>&#x000A;<p>You might notice that the <code>verify</code> action takes over 50% of the run time… we have some ideas here, so stay tuned ;)</p>&#x000A;&#x000A;<p>In the meantime, happy Windows testing!</p>&#x000A;&#x000A;<p><img alt="Confetti Party" src="confetti.gif"/></p>&#x000A;&#x000A; </section> </article> </div> </div> <div id=footerwrap> <div class=container> <em>Made in North America</em> <p>&copy; 2013, <a href='http://heavywaterops.com/'>Heavy Water Operations, LLC (OR)</a>.</p> </div> </div> </body> <script src="../../js/vendor/modernizr-2.6.2.min-76c5a590.js"></script> <script src="../../js/all-126c4e27.js"></script> <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','http://www.google-analytics.com/analytics.js','ga');
    
    ga('create', 'UA-39138312-3', 'kitchen.ci');
    ga('send', 'pageview');
  </script> 
<!-- Mirrored from kitchen.ci/blog/test-kitchen-windows-test-flight-with-vagrant/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 17 Aug 2015 23:12:37 GMT -->
</html>